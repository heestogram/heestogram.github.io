---
layout: single
title: "[R] DACON KBO íƒ€ì OPS ì‹œê°í™” ê²½ì§„ëŒ€íšŒ ì½”ë“œ ë¶„ì„ (1/2)"
excerpt: "DACONì—ì„œ ì£¼ìµœí•œ KBO íƒ€ì OPS ì‹œê°í™” ê²½ì§„ëŒ€íšŒì—ì„œ ì…ìƒí•œ R ì½”ë“œë¥¼ ë¶„ì„í•˜ëŠ” ê¸€ì´ë‹¤."

published: true

categories:
  - R

tags: [R, baseball, baseballr, Baseball Savant]

toc: true
toc_label: "ëª©ì°¨"
toc_sticky: true

date: 2022-12-09 11:22:00
last_modified_at: 2022-12-09 11:22:00
---

<br>

[KBO íƒ€ì OPS ì‹œê°í™” ê²½ì§„ëŒ€íšŒ ì•ˆë‚´ ë§í¬](https://dacon.io/competitions/official/235546/overview/description)

<div class='notice--primary' markdown='1'>
ğŸ’¡
ë³¸ ëŒ€íšŒëŠ” ì•¼êµ¬ ë°ì´í„°ë¡œ ë¶ˆí™•ì‹¤ì„± ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ 2019ë…„ íƒ€ìë“¤ì˜ ìƒë°˜ê¸° ì„±ì  ì˜ˆì¸¡ì„ ëª©í‘œë¡œ í•©ë‹ˆë‹¤.
2019ë…„ íƒ€ìë“¤ì˜ ìƒë°˜ê¸° OPSë¥¼ ì˜ˆì¸¡í•˜ëŠ” ëª¨ë¸ì„ ë§Œë“¤ì–´ ì£¼ì„¸ìš”!
2010ë…„ë¶€í„° 1êµ° ì—”íŠ¸ë¦¬ì— 1ë²ˆ ì´ìƒ í¬í•¨ ë˜ì—ˆë˜ íƒ€ìë“¤ì˜ ì—­ëŒ€ ì •ê·œì‹œì¦Œ, ì‹œë²”ê²½ê¸° ì„±ì  ì •ë³´ë¥¼ ì œê³µí•©ë‹ˆë‹¤.
</div>

ì´ ê¸€ì€ ëŒ€íšŒ ìˆ˜ìƒìì¸ [ê¹€ë¯¼ìˆ˜ ë‹˜ì˜ Rì½”ë“œ](https://dacon.io/competitions/official/235546/codeshare/593?page=1&dtype=recent)ë¥¼ ë¶„ì„í•œ ê²ƒì…ë‹ˆë‹¤.

<br>



## 1. ë°ì´í„°ì¤€ë¹„

```r
install.packages("tidyverse")
library(tidyverse)
install.packages('caret')
library(caret)
install.packages('xgboost')
library(xgboost)
install.packages('knitr')
library(knitr)
install.packages('corrplot')
library(corrplot)

regular_season_batter_day <- read.csv("Regular_Season_Batter_Day_by_Day_b4.csv", fileEncoding = "UTF-8", na.strings=c("","-"),stringsAsFactors = F)
regular_season_batter <- read.csv("Regular_Season_Batter.csv", fileEncoding = "UTF-8", na.strings=c("","-"),stringsAsFactors = F)
```

## 2. ê²°ì¸¡ì¹˜, ì´ìƒì¹˜ ëŒ€ì²´

`complete.cases()` í•¨ìˆ˜ëŠ” ê²°ì¸¡ì¹˜ê°€ ì—†ìœ¼ë©´ TRUE, ìˆìœ¼ë©´ FALSEë¥¼ ë°˜í™˜í•œë‹¤.

ê²°ì¸¡ì¹˜ê°€ ìˆëŠ” í–‰ì„ í™•ì¸í•´ë³´ì.

```r
View(regular_season_batter[!complete.cases(regular_season_batter),])
View(regular_season_batter_day[!complete.cases(regular_season_batter_day),])
```

`sapply()` í•¨ìˆ˜ëŠ” ì–´ë–¤ ê¸°ëŠ¥ì„ ë°˜ë³µì ì¸ ì²˜ë¦¬í•  ì‹œ ë§¤ìš° í¸ë¦¬í•œ í•¨ìˆ˜ì´ë‹¤. ì˜ˆë¥¼ ë“¤ì–´, ë°ì´í„°ì…‹ì— í¬í•¨ëœ ê²°ì¸¡ì¹˜ë¥¼ 0ìœ¼ë¡œ ëŒ€ì²´í•˜ëŠ” ê²½ìš°ì²˜ëŸ¼ ë§ì´ë‹¤.

`which()` í•¨ìˆ˜ëŠ” ì–´ë– í•œ ì¡°ê±´ì„ ë§Œì¡±ì‹œí‚¤ëŠ” ê°’ì˜ ì¸ë±ìŠ¤ë¥¼ ì¶œë ¥í•´ì£¼ëŠ” í•¨ìˆ˜ì´ë‹¤.

```r
#ìˆ«ìí˜•ì¸ ì—´ì˜ ì¸ë±ìŠ¤ë§Œ ë½‘ì•„ë‚¸ë‹¤.
num_col_regular <- which(sapply(regular_season_batter, is.numeric))
#ìˆ«ìí˜•ì¸ ì—´ì—ì„œ ê²°ì¸¡ì¹˜ì¸ í–‰ì˜ ê°’ì„ 0ìœ¼ë¡œ ë°”ê¾¼ë‹¤.
regular_season_batter[,num_col_regular][is.na(regular_season_batter[,num_col_regular])] <- 0
#day íŒŒì¼ì—ë„ ë§ˆì°¬ê°€ì§€ì˜ ê³¼ì •ì„ ê±°ì¹œë‹¤.
num_col_regular <- which(sapply(regular_season_batter_day, is.numeric))
regular_season_batter_day[,num_col_regular][is.na(regular_season_batter_day[,num_col_regular])] <- 0
```

íŠ¹ì´í•˜ê²Œ, 1999,2000ì‹œì¦Œ ëª‡ ì„ ìˆ˜ë“¤ì€ ì•ˆíƒ€ë¥¼ ì³¤ëŠ”ë°ë„ SLGì´ 0ì´ê±°ë‚˜ ì¶œë£¨ë¥¼ í–ˆëŠ”ë°ë„  OBPê°€ 0ì¸ ê²½ìš°ê°€ ìˆë‹¤. ì´ëŸ° ë°ì´í„°ë¥¼ ì§€ì›Œì¤€ë‹¤.

```r
#ê·¸ëŸ¬í•œ íŠ¹ì´í•œ ë°ì´í„°ì˜ í–‰ë²ˆí˜¸ë¥¼ ì°¾ëŠ”ë‹¤.
View(regular_season_batter %>%
       rownames_to_column() %>%
       filter((H>0&SLG==0)|((H>0|BB>0|HBP>0)&OBP==0))
       )

regular_season_batter <- regular_season_batter[-c(479,747,1458,1675,1676,1935,1936),]
```

ë™ëª…ì´ì¸ì´ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤. `unique()`í•¨ìˆ˜ë¡œ `batter_id`ì˜ ë‹¨ì¼ê°œìˆ˜ë¥¼ ì•Œì•„ë‚´ê³  `batter_name`ì˜ ë‹¨ì¼ê°œìˆ˜ë¥¼ ì•Œì•„ë‚¸ í›„ ë‘ ê°’ì´ ê°™ì€ì§€ ë³¸ë‹¤. í™•ì¸ê²°ê³¼ ë™ëª…ì´ì¸ì€ ì—†ë‹¤.

```r
length(unique(regular_season_batter$batter_id))==length(unique(regular_season_batter$batter_name))
length(unique(regular_season_batter_day$batter_id))==length(unique(regular_season_batter_day$batter_name))
```

ì´ì œ ê·œì •íƒ€ì„ì„ ì •ì˜ë‚´ë¦¬ì. 

`scale_x_continuous()`í•¨ìˆ˜ì˜ `breaks` ì˜µì…˜ì€ ì¶• ëˆˆê¸ˆì˜ ìœ„ì¹˜ì™€ ê°’ì„ ì¡°ì •í•œë‹¤.

```r
ggplot(regular_season_batter, aes(AB,OPS)) +
  geom_point(alpha=0.1) +
  scale_x_continuous(breaks=seq(min(regular_season_batter$AB), max(regular_season_batter$AB),by=30)) +
  geom_vline(xintercept = 30,
             color='blue', size=1, linetype='dashed') +
  theme(legend.position='none')
```

<img src="https://user-images.githubusercontent.com/115082062/206626253-04ef3773-e626-4e49-a3ee-e3639988a355.jpg">

ìœ„ ì‚°ì ë„ë¥¼ ë³´ë©´ 30íƒ€ì„ ì´ìƒë¶€í„°ëŠ” ê·¹ë‹¨ì¹˜ê°€ ì¤„ì–´ë“  ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ì§ì ‘ `boxplot`ì— ì €ì¥ëœ ê·¹ë‹¨ì¹˜ê°’ì„ í™•ì¸í•˜ì—¬ë³´ì. `out` ë³€ìˆ˜ëŠ” ê·¹ë‹¨ì¹˜ ê°’ì„ ì €ì¥í•˜ê³  ìˆë‹¤.

`kable()` í•¨ìˆ˜ëŠ” í•¨ìˆ˜ ì•ˆì— í‘œì— í‘œì‹œí•˜ê¸°ë¥¼ ì›í•˜ëŠ” ë°ì´í„°ëª…ì„ ê¸°ì¬í•˜ê¸°ë§Œ í•˜ë©´, ë³„ë„ì˜ ì œëª©í–‰ êµ¬ë¶„ ë“±ì˜ ì‘ì—… ì—†ì´ë„ ê°„ë‹¨íˆ í‘œë¥¼ ê·¸ë¦´ ìˆ˜ ìˆë‹¤.

```r
outliers <- boxplot(regular_season_batter$OPS, plot=FALSE)$out
kable(regular_season_batter[regular_season_batter$OPS %in% outliers,] %>%
        arrange(desc(AB)) %>%
        select(c('batter_name','year','AB','OPS')) %>%
        head(10))

#ê²°ê³¼
|batter_name | year|  AB|       OPS|
|:-----------|----:|---:|---------:|
|í…Œì„ì¦ˆ      | 2015| 472| 1.2936556|
|ê°•ì •í˜¸      | 2014| 418| 1.2001563|
|ìœ ì¬ì‹       | 2018|  33| 1.1920000|
|ê¹€ì›ì„­      | 2005|  25| 0.1169231|
|ì´ì—¬ìƒ      | 2013|  22| 0.0909091|
|ë¬¸ê·œí˜„      | 2007|  18| 0.1090000|
|ê¹€íšŒì„±      | 2010|  17| 0.1050000|
|ì •ê²½ìš´      | 2018|  15| 0.1300000|
|ì •ë³‘ê³¤      | 2018|  15| 0.1300000|
|í˜„ì¬ìœ¤      | 2014|  15| 1.2291667|
```

í…Œì„ì¦ˆë‚˜ ê°•ì •í˜¸ë¥¼ ì œì™¸í•˜ë©´ 33íƒ€ì„ ì´í•˜ì—ì„œ ê·¹ë‹¨ì¹˜ê°€ ë‚˜íƒ€ë‚˜ëŠ” ê²ƒìœ¼ë¡œ ë³´ì¸ë‹¤. 

ì´ì œ ê³¼ê±°ì˜ ì„±ì ì„ ë§Œë“¤ì–´ì£¼ëŠ” `lag_function()`ì„ ì •ì˜í•´ë³´ì. ì´ í•¨ìˆ˜ëŠ” `past`ë…„ ì „ ê¸°ë¡ì„ `lag1_ë³€ìˆ˜ëª…` ìœ¼ë¡œ ì¶”ê°€í•´ì£¼ëŠ” í•¨ìˆ˜ì´ë‹¤.

`paste0()`ì€ ê° ìš”ì†Œë¥¼ ê³µë°± ì—†ì´ ì´ì–´ë¶™ì—¬ì¤€ë‹¤.

`assign()`ì€ ë³€ìˆ˜ì— ê°’ì„ í• ë‹¹í•´ì¤€ë‹¤.

```r
# data_Set: ì´ìš©í•  ë°ì´í„° dataset type : tibble
# var_name: lagë¥¼ ë§Œë“¤ ë³€ìˆ˜ ì´ë¦„  type: character
# past : ëª‡ë„Œì „ lag ë§Œë“¤ì§€ê²°ì •   type : num
lag_function <- function(data_set, var_name, past) {
  data_set <- as.tibble(data_set)
  for(j in c('AB',var_name)){
    assign(paste0("lag",past),c())
    for(i in 1:nrow(data_Set)){
      q <- data_set[(data_set$batter_name==data_set$batter_name[i])&(data_set$year==data_set$year[i]-past),j]
      q <- as.data.frame(q)
      if(nrows(q)==0){
        assign(paste0("lag",past),c(get(paste0("lag",past)),NA))
      }else{
        assign(paste0("lag",past),unlist(c(get(paste0("lag",past)),unname(q))))
      }
    }
    data_Set[,paste0("lag",past,"_",j)] <- get(paste0("lag",past))
    
  }
  index_delete <- which(data_set[,paste0("lag",past,"_","AB")]<30)
  data_set[,paste0("lag",past,"_",var_name)][index_delete,] <-NA
  data_Set[,pastee0("lag",past,"_","AB")] <- NULL
  return(data_Set)
}
```


```r
numvars <- names(which(sapply(regular_season_batter, is.numeric)))
#ì œì™¸í•  ë³€ìˆ˜ë¥¼ dropvarsì— ë„£ì–´ì¤€ë‹¤.
dropvars <- c('batter_id','year','OPS','SLG')
#ìˆ«ì ë³€ìˆ˜ ì¤‘ dropvarsê°€ ì•„ë‹Œ ê²ƒë“¤ë§Œ numvarsì— ë„£ì–´ì¤€ë‹¤.
numvars <- numvars[which(!numvars %in% dropvars)]

regular_season <- regular_season_batter[,c(numvars,'year','batter_name')]
regular_season <- regular_season %>% filter(AB>=30)

#lag_functionìœ¼ë¡œ 1ë…„ ì „ ê¸°ë¡ì„ ì¶”ê°€í•´ì¤€ë‹¤
for(i in numvars){
  regular_season <- lag_function(regular_season,i,1)
}
#selectë¡œ í˜„ì¬ê¸°ë¡ì„ ì œì™¸í•˜ê³  1ë…„ ì „ ê¸°ë¡ë§Œ ë‚¨ê¸´ë‹¤.
regular_season <- regular_season %>%
  select(-c(numvars[-which(numvars %in% 'OBP')], 'batter_name', 'year'))

#ê²°ì¸¡ì¹˜ ìˆëŠ” í–‰ì€ ê³¼ê°íˆ ì‚­ì œí•œë‹¤.
regular_season <- na.omit(regular_season)
```

<br>

## 3. ë³€ìˆ˜ ê°„ ê´€ê³„ íŒŒì•… ë° ë³€ìˆ˜ ì¶”ê°€

ì´ì œ ë³¸ê²©ì ìœ¼ë¡œ 1ë…„ì „ ê¸°ë¡ê³¼ í˜„ì¬  OBP ê°„ì˜ ìƒê´€ê´€ê³„ë¥¼ ë¶„ì„í•´ë³´ì. `cor()`í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©´ ìƒê´€ê´€ê³„ë¥¼ ì•Œ ìˆ˜ ìˆë‹¤. ì•„ë˜ ê²°ê³¼ë¥¼ ë³´ë©´ ë³¼ë„·ì´ ê°€ì¥ ë†’ì€ ìƒê´€ê´€ê³„(0.522)ë¥¼ ê¸°ë¡í•˜ê³ , , ë£¨íƒ€ìˆ˜(TB), íƒ€ì , 1ë…„ì „ ì¶œë£¨ìœ¨, ë“ì ì´ ê·¸ ë’¤ë¥¼ ì‡ëŠ” ê±¸ ì•Œ ìˆ˜ ìˆë‹¤.

```r
cor_num <- cor(regular_season)
#OBPì— ëŒ€í•œ ê°’ë§Œì„ ì¶”ì¶œí•˜ê¸° ìœ„í•´ ì•„ë˜ì²˜ëŸ¼ ì½”ë“œ ì‘ì„±. . ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬í•œë‹¤.
cor_sorted <- as.matrix(sort(cor_num[,'OBP'],decreasing=T))

#ê²°ê³¼
OBP      1.00000000
lag1_BB  0.52235664
lag1_TB  0.49232182
lag1_RBI 0.48325952
lag1_OBP 0.47518685
lag1_R   0.47126124
lag1_H   0.46729040
lag1_HR  0.43891406
lag1_X2B 0.43742370
lag1_avg 0.39288288
lag1_GDP 0.34561438
lag1_G   0.32088934
lag1_SO  0.29747768
lag1_HBP 0.28285334
lag1_CS  0.18706980
lag1_SB  0.16206058
lag1_X3B 0.13508503
lag1_E   0.07634018

#ìƒê´€ê´€ê³„ íˆíŠ¸ë§µì„ ê·¸ë ¤ì¤€ë‹¤.
corrplot.mixed(cor_num[rownames(cor_sorted),rownames(cor_sorted)], tl.col='black', tl.pos='lt', tl.cex=0.7, cl.cex=0.7)

#ì•ì„œ ë§Œë“  ë³€ìˆ˜ë“¤ì„ ì§€ì›Œì¤€ë‹¤.
rm(regular_season, cor_num, cor_sorted)
```

<img src="https://user-images.githubusercontent.com/115082062/206626426-61f9aaa2-ace5-4729-9d58-87d9686470f1.jpg">

ì´ì œ ì „ë°˜ê¸° OBPë¥¼ ê³„ì‚°í•œ í›„ 1,2,3ë…„ ì „ OBPë¥¼ ìƒì„±í•  ê²ƒì´ë‹¤.

ê° ì„ ìˆ˜ì˜ ì „ë°˜ê¸° OBPë¥¼ ê³„ì‚°í•  ê²ƒì¸ë°, `Day_by_Day` ë°ì´í„°ì—ëŠ” í¬ìƒíƒ€ ì •ë³´ê°€ ì—†ê¸° ë•Œë¬¸ì—, `regular_Season_batter` ë°ì´í„°ì—ì„œ í•œ íƒ€ì„ë‹¹ í‰ê·  í¬ìƒíƒ€ë¥¼ ê³„ì‚°í•œ í›„ ì „ë°˜ê¸° í¬ìƒíƒ€ë¥¼ êµ¬í•  ê²ƒì´ë‹¤.

```r
#ì¶œë£¨ìœ¨ ê³µì‹ì„ ì—­ì‚°í•˜ì—¬ í¬ìƒíƒ€ ë³€ìˆ˜ë¥¼ ë§Œë“¤ê¸°
regular_season_batter <- regular_season_batter %>%
  mutate(SF = round((H+BB+HBP)/OBP-(AB+BB+HBP),0))
#í¬ìƒíƒ€ê°€ ê²°ì¸¡ì¹˜ë¼ë©´ 0ìœ¼ë¡œ ë°”ê¿”ì£¼ê¸°
regular_season_batter$SF[is.nan(regular_season_batter$SF)] <- 0

#í•œ íƒ€ì„ë‹¹ í‰ê·  í¬ìƒíƒ€ ì •ë³´ë¥¼ ë‹´ì€ ë°ì´í„° ë§Œë“¤ê¸°
regular_season_batter_SF <- regular_season_batter %>%
  mutate(SF_1 = SF/AB) %>%
  select(batter_name, year, SF_1)
```

ì´ì œ ì „ë°˜ê¸° OBPë¥¼ ê³„ì‚°í•˜ê¸° ìœ„í•œ íƒ€ì„, ì•ˆíƒ€, ë³¼ë„·, ëª¸ì—ë§ëŠ”ë³¼ ì •ë³´ë¥¼ ê°€ì§„ ë°ì´í„°ë¥¼ ë§Œë“¤ ê²ƒì´ë‹¤.

```r
sum_hf_yr_OBP <- regular_season_batter_day %>%
  filter(date<=7.18) %>%
  group_by(batter_name, year) %>%
  summarise(AB=sum(AB), H= sum(H), BB=sum(BB), HBP=sum(HBP))
```

ê·¸ëŸ¬ê³  ì•ì„œ ë§Œë“  í¬ìƒíƒ€ ì •ë³´ ë°ì´í„°(`regular_season_batter_SF`)ì™€ `sum_hf_yr_OBP`ë¥¼ í•©ì³ì¤€ë‹¤.

```r
sum_hf_yr_OBP <- left_join(sum_hf_yr_OBP, regular_season_batter_SF, by=c('batter_name','year'))
#SF_1 ë³€ìˆ˜ëŠ” íƒ€ì„ë‹¹ í¬ìƒíƒ€ ì •ë³´ì´ë¯€ë¡œ ì´ë¥¼ íƒ€ì„ ìˆ˜ë¡œ ê³±í•´ì¤˜ì„œ í¬ìƒíƒ€ ì´ ê°œìˆ˜ë¡œ ë§Œë“¤ì–´ì¤€ë‹¤.
sum_hf_yr_OBP <- sum_hf_yr_OBP %>%
  mutate(SF=round(SF_1*AB,0)) %>%
  select(-SF_1)
```

ì´ì œ ìµœì¢…ì ìœ¼ë¡œ ì „ë°˜ê¸° OBPë¥¼ ê³„ì‚°í•´ì£¼ì. ê²°ì¸¡ì¹˜ëŠ” ì—­ì‹œ 0ìœ¼ë¡œ ë§Œë“ ë‹¤.

```r
sum_hf_yr_OBP <- sum_hf_yr_OBP %>%
  mutate(OBP=(H+BB+HBP)/(AB+BB+HBP+SF))

sum_hf_yr_OBP$OBP[is.nan(sum_hf_yr_OBP$OBP)] <-0

#í•„ìš” ì—†ëŠ” ë³€ìˆ˜ì™€ ê°ì²´ëŠ” ì´ì œ ì‚­ì œí•˜ì
sum_hf_yr_OBP <- sum_hf_yr_OBP %>%
  select(batter_name, year, AB, OBP)

rm(regular_season_batter_SF)
```

ë‚˜ì´ ì—­ì‹œë„ ì¶œë£¨ìœ¨ì— ë¯¸ì¹˜ëŠ” ì¤‘ìš”í•œ ìš”ì†Œì´ë‹¤. ë‚˜ì´ì™€ í‰ê·  ì¶œë£¨ìœ¨ì˜ ê´€ê³„ë¥¼ ê·¸ë˜í”„ë¡œ ì•Œì•„ë³´ì.

```r
#ìš°ì„  ë‚˜ì´ ë³€ìˆ˜ë¥¼ ìƒì„±í•œë‹¤.
regular_season_batter <- regular_season_batter %>%
  mutate(age=year-as.numeric(substr(year_born,1,4)))

ggplot(regular_season_batter %>%
         filter(AB>=30) %>%
         group_by(age) %>%
         summarise(mean_OBP=mean(OBP), median_OBP=median(OBP))) +
  geom_line(aes(x=age, y=mean_OBP),color="#00AFBB", size=1.5, show.legend=TRUE)+
  geom_point(aes(x=age, y=mean_OBP),color='#00AFBB', size=5, show.legend=TRUE)
```

<img src="https://user-images.githubusercontent.com/115082062/206626569-82f58a44-0cb7-48b1-bb80-7723adf657ed.jpg">

30ì„¸ ì „í›„ë¡œ ì¶œë£¨ìœ¨ì´ ì»¤ë¦¬ì–´ í•˜ì´ë¥¼ ë³´ì´ëŠ” ë“¯í•˜ë‹¤.

ì´ì œ `sum_hf_yr_OBP`ì— ë‚˜ì´ ë³€ìˆ˜(`age`)ë„ ì¶”ê°€í•´ì¤€ë‹¤.

```r
batter_age <- regular_season_batter %>%
  select(batter_name, year, age)

batter_age$batter_nmae <- as.character((batter_age$batter_name))
sum_hf_yr_OBP <- left_join(sum_hf_yr_OBP, batter_age, by=c('batter_name', 'year'))
```

ì•ì„œ ìƒì„±í•œ `lag_function`ìœ¼ë¡œ 1,2,3ë…„ ì „ OBPë¥¼ ì¶”ê°€í•´ì¤€ë‹¤.

```r
sum_hf_yr_OBP <- lag_function(sum_hf_yr_OBP,"OBP",1)
sum_hf_yr_OBP <- lag_function(sum_hf_yr_OBP,"OBP",2)
sum_hf_yr_OBP <- lag_function(sum_hf_yr_OBP,"OBP",3)
```

ê·¸ëŸ°ë° ê³¼ê±° OBPë¥¼ ì¶”ê°€í•˜ë‹¤ë³´ë‹ˆ ê²°ì¸¡ì¹˜ê°€ ë°œìƒí–ˆë‹¤. ì´ë¥¼ ì²˜ë¦¬í•´ì£¼ì.

```r
#ê²°ì¸¡ì¹˜ì˜ ìˆ˜ë¥¼ í™•ì¸í•´ë³´ì
rbind('counts'=colSums(is.na(sum_hf_yr_OBP)),"%"=round(colSums(is.na(sum_hf_yr_OBP))/1386,2))

#ê²°ê³¼
       batter_name  year AB OBP age batter_name lag1_OBP lag2_OBP lag3_OBP
counts           0    0  0   0   0           0   569.00   749.00   843.00
%                0    0  0   0   0           0     0.41     0.54     0.61
```

ê³¼ê±°ì˜ OBP ê²°ì¸¡ì¹˜ëŠ” â€˜ê° ì„ ìˆ˜ì˜ OBPì˜ í‰ê· â€™ê³¼ â€˜ê·¸ í•´ ì „ì²´ ì„ ìˆ˜ OBPì˜ í‰ê· â€™ì˜ í‰ê· ìœ¼ë¡œ ëŒ€ì²´í•  ê²ƒì´ë‹¤.

ìš°ì„  ê° ì„ ìˆ˜ë³„ OBP í‰ê· ë¶€í„° êµ¬í•˜ì

```r
player_OBP_mean <- regular_season_batter %>%
  filter(AB>=30) %>%
  group_by(batter_name) %>%
  summarise(AB = sum(AB), H = sum(H), BB = sum(BB), HBP = sum(HBP), SF = sum(SF)) %>% 
  mutate(mean_OBP = (H+BB+HBP)/(AB +BB+HBP+SF)) %>% 
  select(batter_name, mean_OBP)

player_OBP_mean$batter_name <- as.character(player_OBP_mean$batter_name)
```

ê·¸ë¦¬ê³  ì‹œì¦Œë³„ OBP í‰ê· ì„ êµ¬í•˜ì

```r
season_OBP_mean <- regular_season_batter %>%
  filter(AB>=30) %>%
  group_by(year) %>%
  summarise(AB = sum(AB),H = sum(H), BB = sum(BB), HBP = sum(HBP), SF = sum(SF))

season_OBP_mean <- season_OBP_mean %>%
  mutate(mean_OBP = (H+BB+HBP)/(AB +BB+HBP+SF)) %>% select(year, mean_OBP)
```

ì´ì œ ì„ ìˆ˜ë³„ OBP í‰ê· ì€ `sum_hf_yr_OBP`ì— ìƒˆë¡œìš´ ë³€ìˆ˜ë¡œ ë„£ì–´ì¤€ë‹¤. ì´ ë•Œ OBPí‰ê· ì´ ê²°ì¸¡ì¹˜ì¸ í–‰ë“¤ì€ ì—†ì• ë²„ë¦°ë‹¤.

```r
sum_hf_yr_OBP <- left_join(sum_hf_yr_OBP, player_OBP_mean, by='batter_name')
sum_hf_yr_OBP <- sum_hf_yr_OBP[-which(is.na(sum_hf_yr_OBP$mean_OBP)),]
```

ê²°ì¸¡ì¹˜ë¥¼ ì±„ì›Œë„£ëŠ” í•¨ìˆ˜ë¥¼ ì„ ì–¸í•˜ì.

```r
lag_na_fill <- function(data_set, var_name, past, season_var_mean_data){
  for(i in 1:nrow(data_set)){
    if(is.na(data_set[[paste0("lag",past,"_",var_name)]][i])){
      data_set[[paste0("lag",past,"_",var_name)]][i] <- (data_set[[paste0("mean",'_',var_name)]][i] +
                                                           season_var_mean_data[[paste0('mean','_',var_name)]][season_var_mean_data[['year']] %in% (data_set[['year']][i]-past)])/2
    }
  }
  return (data_set)
}

#ì„ ì–¸í•œ í•¨ìˆ˜ë¡œ 1,2,3ë…„ ì „ ê²°ì¸¡ì¹˜ë¥¼ ì±„ì›Œì¤€ë‹¤.
sum_hf_yr_OBP <- lag_na_fill(sum_hf_yr_OBP, 'OBP', 1, season_OBP_mean)
sum_hf_yr_OBP <- lag_na_fill(sum_hf_yr_OBP, 'OBP', 2, season_OBP_mean)
sum_hf_yr_OBP <- lag_na_fill(sum_hf_yr_OBP, 'OBP', 3, season_OBP_mean)
```

ì´ì œëŠ” SLG(ì¥íƒ€ìœ¨)ì„ ê³„ì‚°í•  ì°¨ë¡€ì´ë‹¤. OBPì—ì„œ í–ˆë˜ ê³¼ì •ì„ ë˜‘ê°™ì´ ê±°ì¹˜ë©´ ëœë‹¤.

```r
numvars <- names(which(sapply(regular_season_batter, is.numeric)))
dropvars <- c('batter_id', 'year', 'OPS', 'OBP')
numvars <- numvars[which(!numvars %in% dropvars)]

regular_season <- regular_season_batter[,c(numvars,'year','batter_name')]
regular_season <- regular_season %>%
  filter(AB>=30)

for(i in numvars){
  regular_season <- lag_function(regular_season, i, 1)
}
regular_season <- regular_season %>%
  select(-c(numvars[-which(numvars %in% 'SLG')],'batter_name','year'))
regular_season <- na.omit(regular_season)

cor_num <- cor(regular_season)
cor_sorted <- as.matrix(sort(cor_num[,'SLG'], decreasing=T))
corrplot.mixed(cor_num[rownames(cor_sorted),rownames(cor_sorted)], tl.col = "black", tl.pos = "lt", tl.cex = 0.7, cl.cex = 0.7)
```

ì¥íƒ€ìœ¨ê³¼ ê° ê¸°ë¡ê°„ì˜ ìƒê´€ê´€ê³„ë¥¼ íˆíŠ¸ë§µìœ¼ë¡œ ë‚˜íƒ€ë‚´ë©´ ì•„ë˜ì™€ ê°™ë‹¤.

<img src="https://user-images.githubusercontent.com/115082062/206626647-f8851ef9-26b3-4c16-a12a-d32142c16594.png">

ì´ì œ ì‚¬ìš©í•œ ê°ì²´ë¥¼ ì§€ì›Œì¤€ë‹¤.

```r
rm(regular_season, cor_num, cor_sorted)
```

ì¥íƒ€ìœ¨ ì—­ì‹œë„ ì „ë°˜ê¸° ë°ì´í„°ë¥¼ ë§Œë“¤ì–´ì¤€ë‹¤.

```r
sum_hf_yr_SLG <- regular_season_batter_day %>%
  filter(date<=7.18) %>%
  group_by(batter_name, year) %>%
  summarise(AB=sum(AB), H=sum(H), X2B=sum(X2B), X3B=sum(X3B), HR=sum(HR))

#SLG ë³€ìˆ˜ë¥¼ ì¶”ê°€í•´ì¤€ë‹¤.
sum_hf_yr_SLG <- sum_hf_yr_SLG %>%
  mutate(SLG = (H-(X2B+X3B+HR) + X2B*2 + X3B*3 + HR*4)/AB)

#ê²°ì¸¡ì¹˜ëŠ” 0ìœ¼ë¡œ ë°”ê¾¼ë‹¤.
sum_hf_yr_SLG$SLG[is.nan(sum_hf_yr_SLG$SLG)] <- 0

#í•„ìš”í•œ ì—´ë§Œ ì¶”ì¶œí•œë‹¤.
sum_hf_yr_SLG <- sum_hf_yr_SLG %>%
  select(batter_name, year, AB, SLG)
```

ì•ì„œ ë‚˜ì´ ì •ë³´ë¥¼ ë‹´ì€ `batter_age` í…Œì´ë¸”ì„ ë§Œë“¤ì—ˆì—ˆë‹¤. ì´ë¥¼ SLGí…Œì´ë¸”ê³¼ ê²°í•©í•œë‹¤.

```r
sum_hf_yr_SLG <- left_join(sum_hf_yr_SLG, batter_age, by=c('batter_name', 'year'))
```

1,2,3ë…„ ì „ SLGë¥¼ ì¶”ê°€í•´ì¤€ë‹¤.

```r
sum_hf_yr_SLG <- lag_function(sum_hf_yr_SLG, 'SLG', 1)
sum_hf_yr_SLG <- lag_function(sum_hf_yr_SLG, 'SLG', 2)
sum_hf_yr_SLG <- lag_function(sum_hf_yr_SLG, 'SLG', 3)
```

ì´ì œ ê° ì„ ìˆ˜ë³„ SLG í‰ê· ê³¼ ì‹œì¦Œë³„ SLG í‰ê· ì„ êµ¬í•´ì¤€ë‹¤.

```r
#ê° ì„ ìˆ˜ë³„ SLG í‰ê· 
player_SLG_mean <- regular_season_batter %>%
  filter(AB>=30) %>%
  group_by(batter_name) %>%
  summarise(AB=sum(AB), H=sum(H), X2B=sum(X2B), X3B=sum(X3B), HR=sum(HR)) %>%
  mutate(mean_SLG = ((H-X2B-X3B-HR)+ X2B*2 + X3B*3 + HR*4)/AB) %>%
  select(batter_name, mean_SLG)

player_SLG_mean$batter_name <- as.character(player_SLG_mean$batter_name)

#ì‹œì¦Œë³„ SLG í‰ê· 
season_SLG_mean <- regular_season_batter %>%
  filter(AB>=30) %>%
  group_by(year) %>%
  summarise(AB=sum(AB), H=sum(H), X2B=sum(X2B), X3B=sum(X3B), HR=sum(HR)) %>%
  mutate(mean_SLG = ((H-X2B-X3B-HR)+ X2B*2 + X3B*3 + HR*4)/AB) %>%
  select(year, mean_SLG)
```

`sum_hf_yr_SLG` í…Œì´ë¸”ì— ì„ ìˆ˜ë³„ SLGí‰ê· ì„ ì¶”ê°€í•  ê²ƒì´ë‹¤.

```r
sum_hf_yr_SLG <- left_join(sum_hf_yr_SLG, player_SLG_mean, by='batter_name')

#í‰ê·  SLGê°€ ì—†ëŠ” í–‰ì€ ì§€ì›Œë²„ë¦°ë‹¤.
sum_hf_yr_SLG <- sum_hf_yr_SLG[-which(is.na(sum_hf_yr_SLG$mean_SLG)),]

#1,2,3ë…„ ì „ ê²°ì¸¡ì¹˜ë¥¼ ë§¤ê¿”ì¤€ë‹¤.
sum_hf_yr_SLG <- lag_na_fill(sum_hf_yr_SLG, 'SLG', 1, season_SLG_mean)
sum_hf_yr_SLG <- lag_na_fill(sum_hf_yr_SLG, 'SLG', 2, season_SLG_mean)
sum_hf_yr_SLG <- lag_na_fill(sum_hf_yr_SLG, 'SLG', 3, season_SLG_mean)
```


## 4. ëª¨ë¸ë§, í•™ìŠµ

ì´ì œ ë¨¸ì‹ ëŸ¬ë‹ìœ¼ë¡œ í•™ìŠµì„í•˜ì—¬ ìµœì ì˜ íŒŒë¼ë¯¸í„°ë¥¼ ì°¾ì•„ë³´ì.

ëª¨ë¸ì€ Lasso, RandomForests, XGBoost ë¥¼ ì‚¬ìš©í•´ ê·¸ ì¤‘ ê°€ì¥ ì¢‹ì€ ì„±ëŠ¥ì„ ë³´ì´ëŠ” ê²ƒì„ ì´ìš©í•  ê²ƒì´ë‹¤.  

ê·¸ë¦¬ê³  í‰ê°€ëŠ” wrmsë¡œ ì´ë¤„ì§€ê¸° ë–„ë¬¸ì— ìµœì¢… ì„±ëŠ¥ í‰ê°€ëŠ” wrme í•¨ìˆ˜ë¥¼ ë§Œë“¤ì–´ì„œ í•  ê²ƒì´ë‹¤.

```r
wrmse = function(v,w,p){
  sum(sqrt(((v-p)^2*w)/sum(w)))
}

OBP_data <- sum_hf_yr_OBP %>% filter(AB>=30)
SLG_data <- sum_hf_yr_SLG %>% filter(AB>=30)
```

ìš°ì„  **Lasso**ë¶€í„° í•´ë³´ì.

`caret` íŒ¨í‚¤ì§€ë¡œ ê¸°ê³„í•™ìŠµ ëª¨ë¸ë§ì„ í•  ìˆ˜ ìˆë‹¤. `trainControl()`í•¨ìˆ˜ëŠ” ìƒ˜í”Œë§ ê¸°ë²•ì„ ì§€ì •í•œë‹¤. `method=â€™cvâ€™`ëŠ” êµì°¨ê²€ì¦ì„ ì˜ë¯¸í•œë‹¤. ë¶€íŠ¸ìŠ¤íŠ¸ë©ì´ë‚˜ ë°˜ë³µêµì°¨ê²€ì¦ ë“±ì„ ì§€ì •í•  ìˆ˜ë„ ìˆë‹¤.

```r
my_control <- trainControl(method='cv', number=5)
```

`expand.grid()`í•¨ìˆ˜ëŠ” íŒŒë¼ë¯¸í„°ì˜ ê°’ì„ ëª©ë¡ìœ¼ë¡œ ì§€ì •í•œë‹¤. ì•„ë˜ ì½”ë“œëŠ” lambdaê°’ì„ 0.0001~0.03ê¹Œì§€ 0.0005ê°„ê²©ì˜ ëª©ë¡ìœ¼ë¡œ ì„¤ì •í•œ ê²ƒì´ë‹¤.

`train()`í•¨ìˆ˜ëŠ” ëª¨ë¸ì„ í•™ìŠµì‹œí‚¨ë‹¤. ì´ ë•Œ `method` íŒŒë¼ë¯¸í„°ì— ì–´ë–¤ ë¶„ë¥˜/íšŒê·€ ëª¨ë¸ì„ ì‚¬ìš©í• ì§€ ì§€ì •í•œë‹¤. `trControl`ì—” ë¹„êµ ë°©ì‹ì„ ì§€ì •í•˜ê³ , `tuneGrid`ì— íŒŒë¼ë¯¸í„° ëª©ë¡ì„ ì§€ì •í•œë‹¤.

```r
lassogrid <- expand.grid(alpha=1, lambda=seq(0.0001, 0.03, by=0.0005))

set.seed(3409)
lasso_mod_OBP <- train(x=as.data.frame(OBP_data)[,5:9],y=OBP_data$OBP, method='glmnet', trControl=my_control, tuneGrid = lassogrid)

set.seed(0625)
lasso_mod_SLG <- train(x=as.data.frame(SLG_data)[,5:9], y=SLG_data$SLG, method='glmnet', trControl=my_control, tuneGrid = lassogrid)
```

ì´ì œ **Randomforest**ì˜ ì°¨ë¡€ì´ë‹¤.

`expand.grid()`í•¨ìˆ˜ë¡œ `ntree`(íŠ¸ë¦¬ê°œìˆ˜)ë‚˜ `mtry`(ë³€ìˆ˜ê°œìˆ˜)ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

```r
tuneGrid <- expand.grid(.mtry=c(1:4))

set.seed(0110)
RF_mod_OBP <- train(x=OBP_data[,5:9], y=OBP_data$OBP, method='rf', trControl=my_control, tuneGrid = tuneGrid)
set.seed(0110)
RF_mod_SLG <- train(x=SLG_data[,5:9], y=SLG_data$SLG, method='rf', trControl=my_control, tuneGrid = tuneGrid)
```

ë§ˆì§€ë§‰ìœ¼ë¡œ **XGboost**ë¥¼ ì‚¬ìš©í•´ë³´ì. ì´ëŠ” ê·¸ë˜ë””ì–¸íŠ¸ ë¶€ìŠ¤íŒ… ì•Œê³ ë¦¬ì¦˜ì„ ê¸°ë°˜ìœ¼ë¡œ í•œë‹¤.

```r
label_train_OBP <- OBP_data$OBP
dtrain_OBP <- xgb.DMatrix(data=as.matrix(OBP_data[,5:9]), label=label_train_OBP)
label_train_SLG <- SLG_data$SLG
dtrain_SLG <- xgb.DMatrix(data=as.matrix(SLG_data[,5:9]), label=label_train_SLG)
```

ì´ì œ xgbì— ë“¤ì–´ê°ˆ íŒŒë¼ë¯¸í„°ë¥¼ ì§€ì •í•´ì£¼ê³  í›ˆë ¨ì„ ì‹œí‚¤ì

```r
param <- list(
  objective='reg:linear',
  booster='gbtree',
  eta=0.1, #í•™ìŠµë¥ 
  gamma=0, #minimum loss reduction required to make a further partition on a leaf node of the tree
  max_depth=1, #íŠ¸ë¦¬ì˜ ìµœëŒ€ ê¹Šì´
  min_child_weight=1, #ìë…€ë…¸ë“œì˜ í•©ì˜ weightì˜ ìµœì†Ÿê°’
  subsample=1,
  colsample_bytree=1
)

#nroundsëŠ” ìµœëŒ€ë°˜ë³µíšŸìˆ˜ì´ë‹¤.
set.seed(5694)
xgb_mod_OBP <- xgb.train(data=dtrain_OBP, params=param, nrounds=100)
```

### í‰ê°€ ë° ì˜ˆì¸¡

ì´ì œ predictí•˜ê³  evaluateí•  ë•Œì´ë‹¤.

```r
OBP_data$pr_lasso_OBP <- predict(lasso_mod_OBP, OBP_data[,5:9])
OBP_data$pr_RF_OBP <- predict(RF_mod_OBP, OBP_data[,5:9])
OBP_data$pr_XGB_OBP <- predict(xgb_mod_OBP,dtrain_OBP)

cbind('lasso' = wrmse(OBP_data$OBP, OBP_data$AB, OBP_data$pr_lasso_OBP),
      'RF' = wrmse(OBP_data$OBP, OBP_data$AB, OBP_data$pr_RF_OBP),
      'XGB' = wrmse(OBP_data$OBP, OBP_data$AB, OBP_data$pr_XGB_OBP))
#ê²°ê³¼
       lasso       RF       XGB
[1,] 0.9265484 0.4904435 0.9099517

SLG_data$pr_lasso_SLG <- predict(lasso_mod_SLG, SLG_data[,5:9])
SLG_data$pr_RF_SLG <- predict(RF_mod_SLG, SLG_data[,5:9])
SLG_data$pr_XGB_SLG <- predict(xgb_mod_SLG,dtrain_SLG)

cbind('lasso'=wrmse(SLG_data$SLG, SLG_data$AB, SLG_data$pr_lasso_SLG),
      'RF' = wrmse(SLG_data$SLG, SLG_data$AB, SLG_data$pr_RF_SLG),
      'XGB' = wrmse(SLG_data$SLG, SLG_data$AB, SLG_data$pr_XGB_SLG))

#ê²°ê³¼
lasso        RF      XGB
[1,] 1.763389 0.9139949 1.727737
```

ëœë¤í¬ë ˆìŠ¤íŠ¸ì˜ ì˜¤ì°¨ê°€ ê°€ì¥ ì ìœ¼ë‹ˆ ì„±ëŠ¥ì´ ê°€ì¥ ì¢‹ë‹¤ê³  ë³¼ ìˆ˜ ìˆë‹¤.

ì´ì œ ì–´ë–¤ ë³€ìˆ˜ê°€ ê°€ì¥ í° ì˜í–¥ì„ ì¤¬ëŠ”ì§€ `**feature_importance**`ë¥¼ í™•ì¸í•´ë³´ì.

ë³€ìˆ˜ì˜ ì¤‘ìš”ë„ë¥¼ ì‹œê°í™”í•´ì£¼ëŠ” í•¨ìˆ˜ê°€ `varImp()`ì´ë‹¤.

```r
set.seed(1569)
RF_mod_OBP_FI <- train(x=OBP_data[,5:9], y=OBP_data$OBP, method='rf', trControl=my_control, tuneGrid=tuneGrid, importance=T)
RF_mod_SLG_FI <- train(x=SLG_data[,5:9], y=SLG_data$SLG, method='rf', trControl=my_control, tuneGrid=tuneGrid, importance=T)
par(mfrow=c(1,2))
plot(varImp(RF_mod_OBP_FI, scale=FALSE), main='RF_mod_OBP variable Importance')
plot(varImp(RF_mod_SLG_FI, scale=FALSE), main='RF_mod_SLG variable Importance')
```

<img src="https://user-images.githubusercontent.com/115082062/206626832-bbf2fe86-8f9d-4db0-932a-a6a83052c133.jpg"

<img src="https://user-images.githubusercontent.com/115082062/206627129-510a1d90-b701-4b0a-99e7-73e934b4069b.jpg">

í‰ê·  ì¶œë£¨ìœ¨/ì¥íƒ€ìœ¨ì´ ê°€ì¥ í° ì˜í–¥ì„ ì£¼ì—ˆê³ , ê·¸ ë‹¤ìŒìœ¼ë¡œ 1ë…„ì „ ì„±ì , ë‚˜ì´, 3ë…„ì „ ì„±ì , 2ë…„ì „ ì„±ì  ìˆœìœ¼ë¡œ ì˜í–¥ì„ ì¤¬ë‹¤.

ì œì¶œ íŒŒì¼ì„ ë§Œë“¤ ê²ƒì´ë‹¤. ì œì¶œ íŒŒì¼ì—” ë‚˜ì´, 1,2,3ë…„ ì „ ì„±ì , í‰ê·  ì„±ì ì„ ë„£ì–´ì¤„ ê²ƒì´ë‹¤.

```r
submission <- read.csv('submission.csv', fileEncoding = "UTF-8")

#ë‚˜ì´ë¥¼ ë§Œë“¤ê¸° ìœ„í•´ ìš°ì„  ê´€ì¸¡ë…„ë„(2019) ë³€ìˆ˜ë¥¼ ë§Œë“ ë‹¤
submission$year <- 2019

#ì„ ìˆ˜ì˜ ì¶œìƒë…„ë„ ì •ë³´ë¥¼ ë‹´ì€ í…Œì´ë¸”ì„ ë§Œë“ ë‹¤
regular_season_batter_year_born <- regular_season_batter %>%
  select(batter_id, batter_name, year_born)
regular_season_batter_year_born <- distinct(regular_season_batter_year_born)

submission <- left_join(submission, regular_season_batter_year_born, by=c('batter_id', 'batter_name'))
submission <- submission %>%
  mutate(age= year-as.numeric(substr(year_born,1,4)))

#OBPì™€ SLGë¥¼ ë”°ë¡œ ë§Œë“¤ì–´ì£¼ê³  ë‚˜ì¤‘ì— í•©ì¹œë‹¤
submission_OBP <- submission
submission_SLG <- submission
```

OBPë¶€í„° ë§Œë“¤ì–´ì¤€ë‹¤.

```r
submission_OBP <- left_join(submission_OBP, sum_hf_yr_OBP %>%
                              select(batter_name, mean_OBP) %>%
                              distinct(), by='batter_name')

#1,2,3ë…„ ì „ OBPë¥¼ ì¶”ê°€í•´ì¤€ë‹¤
for(i in c(1,2,3)){
  lag_data <- sum_hf_yr_OBP %>% 
    filter(year==2019-i & AB>=30) %>% 
    select(batter_name, OBP)
    colnames(lag_data)[2] <- paste0("lag",i,"_OBP")
    submission_OBP <- left_join(submission_OBP, lag_data, by='batter_name')
}
```

## 6. ì‚¬í›„ ê²°ì¸¡ì¹˜ ë³´ê°„

í…Œì´ë¸”ì„ ì—´ì–´ë³´ë©´ ê²°ì¸¡ì¹˜ê°€ ê½¤ ë§ë‹¤. ê²°ì¸¡ì¹˜ë“¤ì´ ê°ê°ì˜ ì´ìœ ë¡œ ê²°ì¸¡ë˜ì—ˆê¸° ë•Œë¬¸ì— ê²½ìš°ì— ë§ëŠ” ì²˜ë°©ì„ í•´ì¤˜ì•¼í•œë‹¤.

ìš°ì„  Day_by_Day ë°ì´í„°ì— ëˆ„ë½ë˜ì–´ ê²°ì¸¡ì¹˜ì¸ ì„ ìˆ˜ë“¤ì˜ ê²½ìš°ì´ë‹¤.

```r
for( i in c('ê¹€ì£¼ì°¬','ì´ë²”í˜¸')){
  row_index <- which(submission_OBP$batter_name==i)
  submission_OBP[row_index,]$mean_OBP <- regular_season_batter %>%
    filter(AB>=30 & (batter_name==i)) %>%
    mutate(mean_OBP = sum(AB*OBP)/sum(AB)) %>%
    select(mean_OBP) %>% 
    unique()
  submission_OBP[row_index,]$lag1_OBP <- regular_season_batter %>%
    filter(AB>=30 & (batter_name==i)) %>%
    filter(year==2018) %>%
    select(OBP)
  submission_OBP[row_index,]$lag2_OBP <- regular_season_batter %>%
    filter(AB>=30 & (batter_name==i)) %>%
    filter(year==2017) %>%
    select(OBP)
  submission_OBP[row_index,]$lag3_OBP <- regular_season_batter %>%
    filter(AB>=30 & (batter_name==i)) %>%
    filter(year==2016) %>%
    select(OBP)
}
```

ë‹¤ìŒìœ¼ë¡œ ê°“ ì²« ì‹œì¦Œì„ ì¹˜ë¤„ í‰ê·  OBPê°€ ì—†ëŠ” ì„ ìˆ˜ë“¤ì˜ ê²½ìš°ì´ë‹¤. ì´ ë•Œ ì‹œì¦Œ í‰ê·  OBPë¡œ ê²°ì¸¡ì¹˜ë¥¼ ë§¤ê¿”ì¤€ë‹¤.

```r
row_index <- which(submission_OBP$batter_name %in% c('ê³ ëª…ì„±','ì „ë¯¼ì¬','ê¹€ì² í˜¸','ì‹ ë²”ìˆ˜','ì´ë³‘íœ˜'))
for (i in row_index) submission_OBP[i,]$mean_OBP <- season_OBP_mean %>%
  filter(year==2018) %>%
  select(mean_OBP)
```

ìƒŒì¦ˆì™€ ì „ë³‘ìš°ëŠ” 2018ë…„ í›„ë°˜ê¸° ì„±ì ë§Œ ìˆì–´ì„œ ê²°ì¸¡ì¹˜ê°€ ìƒê¸´ë‹¤.

```r
for(i in c('ì „ë³‘ìš°','ìƒŒì¦ˆ')){
  row_index <- which(submission_OBP$batter_name==i)
  submission_OBP[row_index,]$mean_OBP <- regular_season_batter %>%
    filter(AB>=30 & (batter_name==i)) %>%
    mutate(mean_OBP = sum(AB*OBP)/sum(AB)) %>% select(mean_OBP) %>% unique()
  submission_OBP[row_index,]$lag1_OBP <- regular_season_batter %>%
    filter(AB>=30 & (batter_name==i)) %>%
    filter(year==2018) %>% select(OBP)
}
```

ë‚˜ë¨¸ì§€ ê²°ì¸¡ì¹˜ë“¤ì€ ì€í‡´í–ˆê±°ë‚˜, 1êµ° ê¸°ëŸ‰ì„ ë³´ì—¬ì£¼ì§€ ëª»í•œ ì„ ìˆ˜ë“¤ì´ë¯€ë¡œ í•˜ìœ„ 25%ì„±ì ìœ¼ë¡œ ê²°ì¸¡ì¹˜ë¥¼ ë§¤ê¿”ì¤„ ê²ƒì´ë‹¤.

```r
below_25_index <- which(is.na(submission_OBP$mean_OBP))
submission_OBP$mean_OBP[below_25_index] <- quantile(player_OBP_mean$mean_OBP, 0.25)

submission_OBP[which(sapply(submission_OBP,is.list))] <- sapply(submission_OBP[which(sapply(submission_OBP, is.list))], unlist)
for(i in c(1,2,3)) submission_OBP <- lag_na_fill(submission_OBP,"OBP",i,season_OBP_mean)
```

ì´ì œ SLGë„ OBPì™€ ë™ì¼í•œ ê³¼ì •ì„ ë°Ÿìœ¼ë©´ ëœë‹¤. ìš°ì„  1,2,3ë…„ ì „ SLG ì„±ì  ì—´ì„ ë§Œë“¤ì–´ì¤€ë‹¤.

```r
submission_SLG <- left_join(submission_SLG, sum_hf_yr_SLG %>% select(batter_name, mean_SLG) %>% distinct(), by = "batter_name")

for(i in c(1,2,3)){
  lag_data <- sum_hf_yr_SLG %>% filter(year == 2019 - i & AB >= 30) %>% select(batter_name, SLG)
  colnames(lag_data)[2] <- paste0("lag",i,"_SLG")
  submission_SLG <- left_join(submission_SLG, lag_data, by="batter_name")
}
```

ì•ì„œ ì‚´í´ë³¸ 4ê°€ì§€ ê²½ìš°ì— ë”°ë¼ ê²°ì¸¡ì¹˜ë¥¼ ë§¤ê¿”ì¤€ë‹¤.

```r
case1_name <-c("ê¹€ì£¼ì°¬", "ì´ë²”í˜¸")

for(i in case1_name){
  row_index <- which(submission_SLG$batter_name == i)
  
  submission_SLG[row_index,]$mean_SLG <- regular_season_batter %>% filter(AB>=30 & (batter_name ==i)) %>%
    mutate(mean_SLG = sum(AB * SLG)/sum(AB)) %>% select(mean_SLG) %>% unique()
  
  submission_SLG[row_index,]$lag1_SLG <- regular_season_batter %>% filter(AB>=30 & (batter_name ==i)) %>% 
    filter(year == 2018) %>% select(SLG) %>% as.numeric()
  
  submission_SLG[row_index,]$lag2_SLG <- regular_season_batter %>% filter(AB>=30 & (batter_name ==i)) %>% 
    filter(year == 2017) %>% select(SLG) %>% as.numeric()
  
  submission_SLG[row_index,]$lag3_SLG <- regular_season_batter %>% filter(AB>=30 & (batter_name ==i)) %>% 
    filter(year == 2016) %>% select(SLG) %>% as.numeric()
  
}
```

```r
row_index <- which(submission_SLG$batter_name %in% c("ê¹€ì² í˜¸","ì‹ ë²”ìˆ˜", "ì´ë³‘íœ˜", "ì „ë¯¼ì¬","ê³ ëª…ì„±"))
for(i in row_index) submission_SLG[i,]$mean_SLG <- season_SLG_mean %>% filter(year == 2018) %>% select(mean_SLG)
```

```r
for(i in c("ìƒŒì¦ˆ", "ì „ë³‘ìš°")){
  row_index <- which(submission_SLG$batter_name == i)
  submission_SLG[row_index,]$mean_SLG <- regular_season_batter %>% filter(AB>=30 & (batter_name == i)) %>%
    mutate(mean_SLG = sum(AB * SLG)/sum(AB)) %>% select(mean_SLG) %>% unique()
  
  submission_SLG[row_index,]$lag1_SLG <- regular_season_batter %>% filter(AB>=30 & (batter_name ==i)) %>% filter(year == 2018) %>% select(SLG)
}
```

```r
below_25_index <- which(is.na(submission_SLG$mean_SLG))
submission_SLG$mean_SLG[below_25_index] <- quantile(player_SLG_mean$mean_SLG, 0.25)

submission_SLG[which(sapply(submission_SLG, is.list))] <- sapply(submission_SLG[which(sapply(submission_SLG, is.list))], unlist)

for(i in c(1,2,3)) submission_SLG <- lag_na_fill(submission_SLG, "SLG", i, season_SLG_mean)
```

ì´ì œ ë§ˆì§€ë§‰ìœ¼ë¡œ `predict()`í•¨ìˆ˜ë¥¼ ì´ìš©í•´ ì˜ˆì¸¡ì„ ì§„í–‰í•œë‹¤.

```r
#ì˜ˆì¸¡ì— ìš©ì´í•˜ê²Œ ì—´ ìˆœì„œë¥¼ ë°”ê¾¸ê³  í–‰ì„ ì •ë ¬í•œë‹¤.
submission_OBP <- submission_OBP %>%
  select(c(1:5,7:9,6)) %>%
  arrange(batter_id)
submission_SLG <- submission_SLG %>%
  select(c(1:5,7:9,6)) %>%
  arrange(batter_id)

predict_OBP <- predict(RF_mod_OBP, submission_OBP[,5:9])
predict_SLG <- predict(RF_mod_SLG, submission_SLG[,5:9])

final_submission <- submission %>% select(batter_id, batter_name)
final_submission$OPS <- predict_OBP+predict_SLG

final_submission$OPS <- final_submission$OPS - 0.035
write.csv(final_submission, "Final_Submission.csv", row.names = FALSE)
```
